<!DOCTYPE html>
<html lang="en" th:inline="text">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <div th:replace="jsmodules"></div>
    <title>Control panel</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #ffffff;
      }

      .topnav {
        height: 65px;
      }
      .topnav span {
      }

      .left-panel-container {
        z-index: 1;
        background-color: white;
        width: 255px;
        height: 100vh;
        box-shadow: rgba(60, 64, 67, 0.3) 0px 1px 2px 0px,
          rgba(60, 64, 67, 0.15) 0px 2px 6px 2px;
      }

      .left-panel-container span {
        color: black;
      }

      .rightsideicons {
        width: 300px;
        background-image: linear-gradient(to right top, #67e8f9, #e0f2fe);
        border-radius: 15px;
      }
      .main-container {
        /* background-image: linear-gradient(to right, #e2e8f0, #e2e8f0); */
        background-color: #f8fafc;
      }

      .tableview {
        height: 500px;
        width: 100%;
        overflow: scroll;
        background-color: #ffffff;
        opacity: 0;
        transition: opacity 0.5s;
      }

      ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      li a {
        display: block;
        color: black;
        text-decoration: none;
        padding-left: 10px;
        transition: 0.3s;
        font-size: larger;
      }

      li {
        transition: 0.3s;
      }

      li:hover {
        margin-left: 20px;
      }

      li a:hover {
        color: black;
      }

      .button-48 {
        appearance: none;
        background-color: #ffffff;
        border-width: 0;
        box-sizing: border-box;
        color: #000000;
        cursor: pointer;
        display: inline-block;
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 0;
        line-height: 1em;
        margin: 0;
        opacity: 1;
        outline: 0;
        padding: 1.5em 2.2em;
        position: relative;
        text-align: center;
        text-decoration: none;
        text-rendering: geometricprecision;
        text-transform: uppercase;
        transition: opacity 300ms cubic-bezier(0.694, 0, 0.335, 1),
          background-color 100ms cubic-bezier(0.694, 0, 0.335, 1),
          color 100ms cubic-bezier(0.694, 0, 0.335, 1);
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        vertical-align: baseline;
        white-space: nowrap;
      }

      .button-48:before {
        animation: opacityFallbackOut 0.5s step-end forwards;
        backface-visibility: hidden;
        background-color: #ebebeb;
        clip-path: polygon(-1% 0, 0 0, -25% 100%, -1% 100%);
        content: "";
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        transform: translateZ(0);
        transition: clip-path 0.5s cubic-bezier(0.165, 0.84, 0.44, 1),
          -webkit-clip-path 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
        width: 100%;
      }

      .button-48:hover:before {
        animation: opacityFallbackIn 0s step-start forwards;
        clip-path: polygon(0 0, 101% 0, 101% 101%, 0 101%);
      }

      .button-48:after {
        background-color: #ffffff;
        border-radius: 4px;
      }

      .button-48 span {
        z-index: 1;
        position: relative;
      }
      .shadow-material {
        box-shadow: rgba(60, 64, 67, 0.3) 0px 1px 2px 0px,
          rgba(60, 64, 67, 0.15) 0px 2px 6px 2px;
      }

      /* rainbow border */
      .gradient-border {
        --border-width: 3px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 300px;
        height: 200px;
        font-family: Lato, sans-serif;
        font-size: 2.5rem;
        text-transform: uppercase;
        color: white;
        background: #222;
        border-radius: var(--border-width);
      }
      .gradient-border::after {
        position: absolute;
        content: "";
        top: calc(-1 * var(--border-width));
        left: calc(-1 * var(--border-width));
        z-index: -1;
        width: calc(100% + var(--border-width) * 2);
        height: calc(100% + var(--border-width) * 2);
        background: linear-gradient(
          60deg,
          #5f86f2,
          #a65ff2,
          #f25fd0,
          #f25f61,
          #f2cb5f,
          #abf25f,
          #5ff281,
          #5ff2f0
        );
        background-size: 300% 300%;
        background-position: 0 50%;
        border-radius: calc(2 * var(--border-width));
        animation: moveGradient 4s alternate infinite;
      }
      @keyframes moveGradient {
        50% {
          background-position: 100% 50%;
        }
      }
      .btn-icon-edit {
        background-color: white;
        background: url("[[@{/img/icon/Pencil.svg}]]") no-repeat;
        width: 30px;
        height: 30px;
        border: none;
        transition: 0.2s;
      }
      .btn-icon-edit:hover {
        transform: rotate(45deg);
      }

      .btn-icon-delete {
        background-color: white;
        background: url("[[@{/img/icon/bin.svg}]]") no-repeat;
        width: 30px;
        height: 30px;
        border: none;
      }
      .btn-icon-delete:hover {
        background: url("[[@{/img/icon/bin-hover.svg}]]") no-repeat;
      }
    </style>
  </head>
  <body>
    <!-- 商品選取照片預覽 -->
    <script>
      function loadImageFileAsURL() {
        let filesSelected = document.getElementById("inputFileToLoad").files;
        if (filesSelected.length > 0) {
          let fileToLoad = filesSelected[0];

          let fileReader = new FileReader();

          fileReader.onload = function (fileLoadedEvent) {
            fileDataURL = fileLoadedEvent.target.result;
          };

          fileReader.readAsDataURL(fileToLoad);
        }
      }
    </script>
    <!-- 商品選取照片預覽 -->
    <div class="d-flex">
      <div class="left-panel-container">
        <div class="m-2 d-flex">
          <img th:src="@{/img/icon/logo.svg}" style="height: 65px" />

          <div class="m-2">
            <span> Final pretty </span>
            <br />
            <span> 後台管理 </span>
          </div>
        </div>
        <div class="m-3">
          <hr />
          <nav class="adminnav">
            <ul class="d-flex flex-column">
              <li class="my-2 d-flex">
                <img th:src="@{/img/icon/Pencil.svg}" />
                <a
                  class="adminlink"
                  href="#"
                  data-url="http://localhost:8082/public/api/article/categories"
                  data-title="文章管理"
                  >文章管理</a
                >
              </li>
              <li class="my-2 d-flex">
                <img th:src="@{/img/icon/VideoCam.svg}" />
                <a
                  class="adminlink"
                  href="#"
                  data-url="http://localhost:8082/public/api/video/manage"
                  data-title="影片管理"
                  >影片管理</a
                >
              </li>
              <li class="my-2 d-flex">
                <img th:src="@{/img/icon/Users.svg}" /><a href="#">會員管理</a>
              </li>
              <li class="my-2 d-flex">
                <img th:src="@{/img/icon/Pencil.svg}" /><a href="#">貼文管理</a>
              </li>
              <li class="my-2 d-flex">
                <img th:src="@{/img/icon/shop.svg}" /><a
                  class="adminlink"
                  href="#"
                  data-title="商城管理"
                  data-url="http://localhost:8082/admin/api/listProduct"
                  >商城管理</a
                >
              </li>
            </ul>
          </nav>
        </div>
      </div>
      <div class="main-container flex-grow-1">
        <nav class="topnav d-flex justify-content-between p-2 my-3 mx-5">
          <div class="greetings px-1">
            <h2 id="clock"></h2>
          </div>
          <div
            class="rightsideicons d-flex justify-content-between shadow-material"
          >
            <div class="m-1 p-2">
              <strong>
                您好，[[${#authentication.getPrincipal().getNickname()}]]</strong
              >
            </div>
            <div>
              <a th:href="@{/perform_logout}"
                ><img
                  class="my-2 me-3"
                  th:src="@{/img/icon/Logout.svg}"
                  alt=""
                  style="height: 30px"
              /></a>
              <a href=""
                ><img
                  class="my-2 me-3"
                  th:src="@{/img/icon/adminlogo.svg}"
                  alt=""
                  style="height: 30px"
              /></a>
            </div>
          </div>
        </nav>

        <div class="m-5 d-flex justify-content-between">
          <div class="left d-flex align-items-center justify-content-between">
            <h1 id="tabletitle" class="mx-2">文章管理</h1>
            <span id="datatotal" class="mx-2">100位會員 </span>
          </div>
          <div
            class="searchbar bg-white rounded d-flex justify-content-between p-2 ms-2 shadow-material"
          >
            <input
              id="searchinput"
              size="40"
              class="bg-white border-0"
              placeholder="輸入關鍵字搜尋..."
            />
            <button class="btn" id="searchbtn">
              <img th:src="@{/img/icon/search.svg}" alt="" />
            </button>
          </div>
        </div>
        <div class="mx-5 width-100 bg-white shadow-material rounded-3 p-3">
          <div class="m-1 d-flex justify-content-end">
            <button class="button-48" id="showtable">
              <span style="font-size: large">顯示所有資料</span>
            </button>
            <button id="exportCSV" class="button-48">
              <span style="font-size: large">匯出成csv檔</span></button
            ><button class="button-48">
              <span id="filterbtn" style="font-size: large">過濾條件</span>
            </button>
          </div>
          <div id="table" class="tableview"></div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">商品修改</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form id="myForm">
            <div class="modal-body">
              <div class="mb-3">
                <label for="recipient-title" class="col-form-label"
                  >商品名稱:</label
                >
                <input
                  name="title"
                  type="text"
                  class="form-control"
                  id="recipient-title"
                  value=""
                  required
                />
              </div>
              <div class="mb-3">
                <label for="message-price" class="col-form-label"
                  >商品價格:</label
                >
                <input
                  name="price"
                  type="number"
                  min="0"
                  class="form-control"
                  id="recipient-price"
                  value=""
                  required
                />
              </div>
              <div class="mb-3">
                <label for="message-stock" class="col-form-label"
                  >商品庫存:</label
                >
                <input
                  name="stock"
                  type="number"
                  class="form-control"
                  id="recipient-stock"
                  value=""
                  required
                />
              </div>
              <div class="mb-3">
                <label for="message-text" class="col-form-label"
                  >商品簡介:</label
                >
                <textarea
                  name="text"
                  class="form-control"
                  id="recipient-text"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                商品種類:<select id="type">
                  <option>運動食品</option>
                  <option>運動用品</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="inputFileToLoad" class="col-form-label"
                  >商品圖片:</label
                >
                <input
                  id="inputFileToLoad"
                  type="file"
                  name="file"
                  onchange="loadImageFileAsURL()"
                  class="file-upload-default"
                />
              </div>
              <div class="mb-3">
                <img
                  id="preview_img"
                  th:src="@{#}"
                  style="
                    height: 300px;
                    width: 300px;
                    border-radius: 60px 60px 60px 60px;
                    margin-left: 30px;
                  "
                />
                <input id="onsale" name="onsale" value="" hidden />
                <input id="product_id" name="product_id" value="" hidden />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button id="send" type="submit" class="btn btn-primary">
                Send
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
  <script th:src="@{/js/ajax.js}"></script>
  <script>
    ("use strict");
    //抓取元素
    //設定頁面改變所需要之變數
    let clock = document.getElementById("clock");
    let tabletitle = document.getElementById("tabletitle");
    let showAllurl = "http://localhost:8082/public/api/article/categories";
    //綁定table view 的變數
    let tableData;
    let initialTableData;

    //設定小時鐘
    const monthNamesZh = [
      "一月",
      "二月",
      "三月",
      "四月",
      "五月",
      "六月",
      "七月",
      "八月",
      "九月",
      "十月",
      "十一月",
      "十二月",
    ];
    const dayNamesZh = [
      "星期日",
      "星期一",
      "星期二",
      "星期三",
      "星期四",
      "星期五",
      "星期六",
    ];

    const getclocktime = () => {
      let d = new Date();
      let s = d.getSeconds();
      let m = d.getMinutes();
      let h = d.getHours();
      let D = d.getDay();
      let date = d.getDate();
      let M = d.getMonth();
      let year = d.getFullYear();

      return `${year}年 ${monthNamesZh[M]}${date}日${dayNamesZh[D]} ${h}:${m}`;
    };

    const setclock = () => {
      clock.innerHTML = `${getclocktime()}`;
    };
    setclock();
    setInterval(() => {
      setclock();
    }, 1000);

    //定義 ajax 函數
    const postdata = (url, requestJSON, callbackfunction) => {
      let myHeaders = new Headers();
      myHeaders.append("Content-Type", "application/json");
      let registerdata = JSON.stringify(requestJSON);
      let requestOptions = {
        method: "POST",
        headers: myHeaders,
        body: registerdata,
        redirect: "follow",
      };
      fetch(url, requestOptions)
        .then((response) => response.json())
        .then((result) => {
          callbackfunction(result);
        })
        .catch((error) => console.error("error", error));
    };
    const getdata = (url, callbackfunction) => {
      let requestOptions = {
        method: "GET",
        redirect: "follow",
      };
      fetch(url, requestOptions)
        .then((response) => response.json())
        .then((result) => {
          tableData = result;
          callbackfunction(result);
        })
        .catch((error) => console.error("error", error));
    };

    // //將json陣列轉為 table
    // const jsonToHTMLbyQ = (querySelector, json) => {
    //   if (json.length == 0) {
    //     document.querySelector(querySelector).innerHTML = "";
    //     return;
    //   }
    //   //define table head
    //   let title = `<thead><tr>${Object.keys(json[0])
    //     .map((el) => `<th><strong>${el}</strong></th>`)
    //     .join("")}<th>操作</th></tr></thead>`;
    //   // define table body
    //   let trs = json.map(
    //     (el) =>
    //       `${Object.values(el)
    //         .map((td) => `<td class="data">${td}</td>`)
    //         .join("")}<td><button class="save btn-icon-edit"></button>
    //         <button class="delete btn-icon-delete"></button></td>`
    //   );
    //   let tbody = `<tbody>${trs
    //     .map((el) => `<tr>${el}</tr>`)
    //     .join("")}</tbody>`;
    //   let table = `<table class="table table-hover">${title}${tbody}</table>`;
    //   document.querySelector(querySelector).innerHTML = table;
    // };

    // //按鈕觸發呈現table
    // document.getElementById("showtable").addEventListener("click", () => {
    //   document.querySelector("#table").style.opacity = 0;
    //   setTimeout(() => {
    //     getdata(showAllurl, (result) => {
    //       //make a copy of data
    //       [...initialTableData] = [...result];
    //       jsonToHTMLbyQ("#table", result);
    //       document.querySelector("#table").style.opacity = 1;
    //     });
    //   }, 300);
    // });

    //按鈕觸發呈現table 商品管理部分
    //將json陣列轉為 table 商品管理部分
    const jsonToHTMLbyQ = (querySelector, json) => {
      if (json.length == 0) {
        document.querySelector(querySelector).innerHTML = "";
        return;
      }
      //define table head
      let title = `<thead><tr>${Object.keys(json[0])
        .map((el) => `<th><strong>${el}</strong></th>`)
        .join("")}<th>商品圖</th><th>操作</th></tr></thead>`;
      // define table body
      let trs = json.map(
        (el) =>
          `${Object.values(el)
            .map((td, index) => {
              if (index == 4) {
                if (td == 1) {
                  return `<td class="data"><span id="${td}" name="${el.product_id}" style='color:green'>販售中</span></td>`;
                } else {
                  return `<td class="data"><span id="${td}" name="${el.product_id}" style='color:red'>下架中</span></td>`;
                }
              } else if (index == 7) {
                return `<td><class="date">${td}</td><td><img style="width:50px; height:50px" src="/admin/downloadImage/${el.product_id}"></td>`;
              } else {
                return `<td class="data">${td}</td>`;
              }
            })
            .join("")}<td><button id="${el.product_id}"
              name="checkboxone"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#exampleModal"
              data-bs-whatever="@getbootstrap" class="save btn-icon-edit"></button>
            <button id="${el.product_id}"
              name="deletebox" class="delete btn-icon-delete"></button><button name="onsale" id="${
                el.product_id
              }" class="btn btn-primary">上下架</button></td>`
      );
      let tbody = `<tbody>${trs
        .map((el) => `<tr>${el}</tr>`)
        .join("")}</tbody>`;
      let table = `<table class="table table-hover">${title}${tbody}</table>`;
      document.querySelector(querySelector).innerHTML = table;
    };
    document.getElementById("showtable").addEventListener(
      "click",
      (product = () => {
        document.querySelector("#table").style.opacity = 0;
        setTimeout(() => {
          getdata(showAllurl, (result) => {
            //make a copy of data
            [...initialTableData] = [...result];
            jsonToHTMLbyQ("#table", result);
            document.querySelector("#table").style.opacity = 1;
            //商品圖片預覽
            var inputFileToLoad = $("#inputFileToLoad");
            inputFileToLoad.change(function () {
              readURL(this);
            });
            function readURL(input) {
              if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                  $("#preview_img").attr("src", e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
              }
            }
            //商品上下架
            $("button[name='onsale']").click(
              (updateOnsale = (e) => {
                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");
                var id = $(e.target).attr("id");
                console.log(id);
                var onsale = $(`span[name="${id}"]`).attr("id");
                console.log(onsale);
                var requestOptions = {
                  method: "POST",
                  headers: myHeaders,
                  redirect: "follow",
                };

                fetch(
                  `http://localhost:8082/admin/api/changeOnsale/${id}/${onsale}`,
                  requestOptions
                )
                  .then((response) => response.json())
                  .then((result) => {
                    console.log(result);
                    if (result.onsale == 1) {
                      $(`span[name="${$(e.target).attr("id")}"]`)
                        .attr("id", result.onsale)
                        .attr("style", "color:green")
                        .text("販售中");
                    } else {
                      $(`span[name="${$(e.target).attr("id")}"]`)
                        .attr("id", result.onsale)
                        .attr("style", "color:red")
                        .text("下架中");
                    }
                  })
                  .catch((error) => console.log("error", error));
              })
            );

            $("button[name='checkboxone']").click(
              (updateQuery = (e) => {
                console.log("好痛苦");
                var product_id = $(e.target).attr("id");
                var requestOptions = {
                  method: "GET",
                  redirect: "follow",
                };
                fetch(
                  "http://localhost:8082/admin/updateProduct?product_id=" +
                    product_id,
                  requestOptions
                )
                  .then((response) => response.json())
                  .then((result) => {
                    console.log(result.product_id);
                    $("#recipient-title").attr("value", result.title);
                    $("#recipient-price").attr("value", result.price);
                    $("#recipient-stock").attr("value", result.stock);
                    $("#recipient-text").text(result.text);
                    $("#onsale").attr("value", result.onsale);
                    $("#product_id").attr("value", result.product_id);
                    $("#preview_img").attr(
                      "src",
                      "/admin/downloadImage/" + result.product_id
                    );
                  })
                  .catch((error) => console.log("error", error));
              })
            );

            $("#send").click(
              (update = (e) => {
                e.preventDefault();
                var myHeaders = new Headers();
                var datas = new FormData();
                datas.append("product_id", $("#product_id").val());
                datas.append("title", $("#recipient-title").val());
                datas.append("price", $("#recipient-price").val());
                datas.append("stock", $("#recipient-stock").val());
                datas.append("text", $("#recipient-text").val());
                datas.append("type", $("#type option:selected").text());
                datas.append("file", $("#inputFileToLoad")[0].files[0]);
                datas.append("onsale", $("input[name='onsale']").val());

                var requestOptions = {
                  method: "POST",
                  headers: myHeaders,
                  body: datas,
                  redirect: "follow",
                };

                fetch(
                  "http://localhost:8082/admin/api/updateProduct",
                  requestOptions
                )
                  .then((response) => response.json())
                  .then((result) => {
                    console.log(result);
                    if (result) {
                      alert("更新成功");
                      product();
                    } else {
                      alert("更新失敗");
                      product();
                    }
                  })
                  .catch((error) => console.log("error", error));
              })
            );

            $("button[name='deletebox']").click(
              (deleteproduct = (e) => {
                if (confirm("確定刪除嗎?") == true) {
                  var myHeaders = new Headers();
                  myHeaders.append("Content-Type", "application/json");

                  var requestOptions = {
                    method: "GET",
                    headers: myHeaders,
                    redirect: "follow",
                  };

                  fetch(
                    "http://localhost:8082/public/api/deleteProduct?product_id=" +
                      $(e.target).attr("id"),
                    requestOptions
                  )
                    .then((response) => response.json())
                    .then((result) => {
                      if (result) {
                        product();
                      } else {
                        alert("訂單中有此商品故不可刪除");
                        product();
                      }
                    })
                    .catch((error) => console.log("error", error));
                }
              })
            );
          });
        }, 300);
      })
    );

    //將輸入文字存成檔案
    function saveTextAsFile(_fileName, _text) {
      var textFileAsBlob = new Blob([_text], { type: "text/plain" });

      var downloadLink = document.createElement("a");
      downloadLink.download = _fileName;
      downloadLink.innerHTML = "Download File";
      if (window.webkitURL != null) {
        // Chrome allows the link to be clicked
        // without actually adding it to the DOM.
        downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
      } else {
        // Firefox requires the link to be added to the DOM
        // before it can be clicked.
        downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
        downloadLink.onclick = destroyClickedElement;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
      }
      downloadLink.click();
    }

    function destroyClickedElement(event) {
      document.body.removeChild(event.target);
    }

    document.getElementById("exportCSV").addEventListener("click", () => {
      if (!tableData) {
        alert("table is null!");
        return;
      }
      var fields = Object.keys(tableData[0]);
      var replacer = function (key, value) {
        return value === null ? "" : value;
      };
      var csv = tableData.map(function (row) {
        return fields
          .map(function (fieldName) {
            return JSON.stringify(row[fieldName], replacer);
          })
          .join(",");
      });
      csv.unshift(fields.join(",")); // add header column
      csv = csv.join("\r\n");
      //create a download link and click and destroy it
      let filename = saveTextAsFile("test.csv", csv);
    });

    //TODO:排序資料，過濾
    document.getElementById("filterbtn").addEventListener("click", () => {
      alert("施工中");
    });

    //模糊搜尋
    const selectMatchItem = (lists, keyWord) => {
      let reg = new RegExp(keyWord);
      let resArr = [];
      if (!lists) return;
      lists.filter((item) => {
        for (let i in item) {
          if (reg.test(item[i])) {
            resArr.push(item);
            return;
          }
        }
      });
      return resArr;
    };

    document.getElementById("searchinput").addEventListener("change", () => {
      if (!document.getElementById("searchinput").value) {
        jsonToHTMLbyQ("#table", initialTableData);
        return;
      }

      let result = selectMatchItem(
        tableData,
        document.getElementById("searchinput").value
      );
      jsonToHTMLbyQ("#table", result ? result : []);
    });

    //切換頁面功能
    for (let e of document.getElementsByClassName("adminlink")) {
      e.addEventListener("click", (f) => {
        tabletitle.innerText = f.target.dataset.title;
        showAllurl = f.target.dataset.url;
        addurl = f.target.dataset.addurl;
      });
    }
  </script>
</html>
