<!DOCTYPE html>
<html lang="en">
  <html xmlns:th="http://www.thymeleaf.org"></html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <div th:replace="jsmodules"></div>

    <title>商城</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
      integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.1.1.slim.min.js"
      integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
      integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"
      integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        background-color: white;
        background-size: 100vw;
        min-height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: column;
      }
      footer {
        min-height: 100px;
        background: PapayaWhip;
      }
      article {
        flex: 1;
      }

      .show-cart li {
        display: flex;
      }
      .card {
        margin-bottom: 20px;
      }
      .card-img-top {
        width: 200px;
        height: 200px;
        align-self: center;
      }

      .card-title {
        color: rgb(54, 143, 109);
        font-size: large;
      }
    </style>
  </head>

  <body>
    <div th:replace="component/navbar :: navbar"></div>
    <div th:replace="component/chatbubble"></div>

    <article>
      <div>
        <ul class="d-flex justify-content-center" style="list-style: none">
          商品分類：　
          <li>
            <a
              style="pointer-events: none; color: black"
              th:href="@{/public/storefrontend}"
              >全部商品</a
            >　/　
          </li>
          <li><a th:href="@{/public/eatproduct}">食品</a>　/　</li>
          <p></p>
          <li>
            <a th:href="@{/public/useproduct}">用品</a>
          </li>
        </ul>
      </div>

      <div class="container">
        <div class="row">
          <div class="row justify-content-center align-items-center">
            <div
              class="card p-1 shadow m-3"
              style="
                width: 20rem;
                display: flex;
                flex-direction: column;
                height: 700px;
                width: 30%;
                margin: 0 auto;
                background-color: #ccc;
              "
              th:each="product : ${productlist} "
            >
              <div class="" style="overflow: hidden">
                <img
                  th:id="${product.product_id}"
                  th:src="@{'/public/downloadImage/'+${product.product_id}}"
                  alt=""
                  class="card-img"
                />
              </div>
              <div class="card-body">
                <h4 class="card-title" th:text="${product.title}"></h4>
                <p class="card-text" th:text="'$'+${product.price}"></p>
                <p class="card-text" th:text="${product.text}"></p>
                <p
                  style="visibility: hidden"
                  class="card-text"
                  th:text="${product.product_id}"
                ></p>

                <button
                  th:if="${product.volume} == ${product.stock}"
                  class="add-to-cart btn btn-secondary disabled text-dark"
                  style="background-color: #64748b"
                >
                  加入購物車
                </button>

                <a
                  th:if="${product.volume} != ${product.stock}"
                  href="#"
                  th:data-name="${product.title}"
                  th:data-price="${product.price}"
                  th:data-img="@{'/public/downloadImage/'+${product.product_id}}"
                  th:data-id="${product.product_id}"
                  class="add-to-cart btn btn-secondary text-dark"
                  style="background-color: #64748b"
                  >加入購物車</a
                >
                  加入購物車
                </a>

                <span
                  th:if="${product.volume} > 1 and ${product.volume} != ${product.stock}"
                  style="color: red; font-weight: bold"
                  ><i class="bi bi-fire"></i> 熱賣中</span
                >
                <span
                  th:unless="${product.volume} != ${product.stock}"
                  style="color: rgb(12, 39, 139); font-weight: bold"
                  ><i class="bi bi-cart-x"></i> 缺貨</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
      <div th:replace="component/cart"></div>
    </article>

    <footer>
      <div th:replace="component/footer"></div>
    </footer>
  </body>
  <script th:inline="javascript">
    /*<![DATA[*/
    // ************************************************
    // Shopping Cart API
    // ************************************************
    function myFunction(stock) {
      if (stock == 0) {
        addcartbtn.style.display = "none";
      }
    }

    var shoppingCart = (function () {
      // =============================
      // Private methods and propeties
      // =============================
      cart = [];

      // Constructor
      function Item(name, price, count, img, product_id) {
        this.name = name;
        this.price = price;
        this.count = count;
        this.product_id = product_id;
        this.img = img;
      }

      // Save cart
      function saveCart() {
        sessionStorage.setItem("shoppingCart", JSON.stringify(cart));
      }

      // Load cart
      function loadCart() {
        cart = JSON.parse(sessionStorage.getItem("shoppingCart"));
      }
      if (sessionStorage.getItem("shoppingCart") != null) {
        loadCart();
      }

      // =============================
      // Public methods and propeties
      // =============================
      var obj = {};

      // Add to cart
      obj.addItemToCart = function (name, price, count, img, product_id) {
        for (var item in cart) {
          if (cart[item].name === name) {
            cart[item].count++;
            saveCart();
            return;
          }
        }
        var item = new Item(name, price, count, img, product_id);
        cart.push(item);
        saveCart();
      };
      // Set count from item
      obj.setCountForItem = function (name, count) {
        for (var i in cart) {
          if (cart[i].name === name) {
            cart[i].count = count;
            break;
          }
        }
      };
      // Remove item from cart
      obj.removeItemFromCart = function (name) {
        for (var item in cart) {
          if (cart[item].name === name) {
            cart[item].count--;
            if (cart[item].count === 0) {
              cart.splice(item, 1);
            }
            break;
          }
        }
        saveCart();
      };

      // Remove all items from cart
      obj.removeItemFromCartAll = function (name) {
        for (var item in cart) {
          if (cart[item].name === name) {
            cart.splice(item, 1);
            break;
          }
        }
        saveCart();
      };

      // Clear cart
      obj.clearCart = function () {
        cart = [];
        saveCart();
      };

      // Count cart
      obj.totalCount = function () {
        var totalCount = 0;
        for (var item in cart) {
          totalCount += cart[item].count;
        }
        return totalCount;
      };

      // Total cart
      obj.totalCart = function () {
        var totalCart = 0;
        for (var item in cart) {
          totalCart += cart[item].price * cart[item].count;
        }
        return Number(totalCart.toFixed(2));
      };

      // List cart
      obj.listCart = function () {
        var cartCopy = [];
        for (i in cart) {
          item = cart[i];
          itemCopy = {};
          for (p in item) {
            itemCopy[p] = item[p];
          }
          itemCopy.total = Number(item.price * item.count).toFixed(2);
          cartCopy.push(itemCopy);
        }
        return cartCopy;
      };

      // cart : Array
      // Item : Object/Class
      // addItemToCart : Function
      // removeItemFromCart : Function
      // removeItemFromCartAll : Function
      // clearCart : Function
      // countCart : Function
      // totalCart : Function
      // listCart : Function
      // saveCart : Function
      // loadCart : Function
      return obj;
    })();

    // *****************************************
    // Triggers / Events
    // *****************************************
    // Add item
    $(".add-to-cart").click(function (event) {
      event.preventDefault();
      let imgsrc = event.target.parentElement.parentElement
        .getElementsByTagName("img")
        .item(0).src;

      let imgid = event.target.parentElement.parentElement
        .getElementsByTagName("img")
        .item(0).id;

      var name = $(this).data("name");
      var price = Number($(this).data("price"));
      var img = $(this).data("img");
      //console.log(img);
      // var product_id = Number($(this).data("product_id"));
      // console.log(product_id);
      shoppingCart.addItemToCart(name, price, 1, img, imgid);
      displayCart(imgid, imgsrc);
    });

    // Clear items
    $(".clear-cart").click(function () {
      shoppingCart.clearCart();
      displayCart();
    });

    function displayCart() {
      console.log(sessionStorage["shoppingCart"].length);
      document.querySelector("#nextbtn").disabled = false;
      document.getElementById("nextbtn").style.display = "block";
      if (sessionStorage["shoppingCart"].length == 2) {
        document.querySelector("#nextbtn").disabled = true;
        document.getElementById("nextbtn").style.display = "none";
      }

      document.querySelector("#cleanbtn").disabled = false;
      document.getElementById("cleanbtn").style.display = "block";
      if (sessionStorage["shoppingCart"].length == 2) {
        console.log("in");
        document.querySelector("#cleanbtn").disabled = true;
        document.getElementById("cleanbtn").style.display = "none";
      }

      var cartArray = shoppingCart.listCart();
      var output = "";

      for (i in cartArray) {
        console.log(cartArray[i].img + "+++++++++++++++++++");
        output +=
          "<tr>" +
          "<td style='visibility:hidden'>" +
          cartArray[i].product_id +
          "</td>" +
          "<td>" +
          cartArray[i].name +
          "</td>" +
          "<td>$" +
          cartArray[i].price +
          "</td>" +
          '<td><img src="' +
          cartArray[i].img +
          ' " height="200" width="200"/></td>' +
          "<td><div class='input-group'><button class='minus-item input-group-addon btn btn-primary' data-name=" +
          cartArray[i].name +
          ">-</button>" +
          "<input type='number' class='item-count form-control'  data-name='" +
          cartArray[i].name +
          "' value='" +
          cartArray[i].count +
          "'>" +
          "<button class='plus-item btn btn-primary input-group-addon' data-name=" +
          cartArray[i].name +
          ">+</button></div></td>" +
          "<td><button class='delete-item btn btn-danger' style='margin: 6px 0 0 0;width: 30px;font-size: 13px;border: 1px solid black;color: black;'data-name=" +
          cartArray[i].name +
          ">X</button></td>" +
          " = " +
          "<td>$" +
          cartArray[i].total +
          "</td>" +
          "</tr>";
      }
      $(".show-cart").html(output);
      $(".total-cart").html(shoppingCart.totalCart());
      $(".total-count").html(shoppingCart.totalCount());
    }

    // Delete item button

    $(".show-cart").on("click", ".delete-item", function (event) {
      var name = $(this).data("name");
      shoppingCart.removeItemFromCartAll(name);
      displayCart();
    });

    // -1
    $(".show-cart").on("click", ".minus-item", function (event) {
      var name = $(this).data("name");
      shoppingCart.removeItemFromCart(name);
      displayCart();
    });
    // +1
    $(".show-cart").on("click", ".plus-item", function (event) {
      var name = $(this).data("name");
      shoppingCart.addItemToCart(name);
      displayCart();
    });

    // Item count input
    $(".show-cart").on("change", ".item-count", function (event) {
      var name = $(this).data("name");
      var count = Number($(this).val());
      shoppingCart.setCountForItem(name, count);
      displayCart();
    });

    displayCart();
    /*]]>*/
  </script>
</html>
